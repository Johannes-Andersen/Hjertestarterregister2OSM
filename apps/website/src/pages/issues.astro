---
import { SyncStoreClient } from "@repo/sync-store";
import IssueCards from "../components/issues/IssueCards.astro";
import IssueTypeCountList from "../components/issues/IssueTypeCountList.astro";
import Panel from "../components/ui/Panel.astro";
import Layout from "../layouts/Layout.astro";
import { formatNumber } from "../utils/formatNumber";

export const prerender = false;

const syncStore = new SyncStoreClient({
  connectionString: Astro.locals.runtime.env.HYPERDRIVE.connectionString,
  ssl: import.meta.env.DEV ? "require" : false,
});

const latestRunId = await syncStore.getLatestRunId();

const runFilter = latestRunId ? { runId: latestRunId } : {};

const [issues, issueTypeCounts] = await Promise.all([
  syncStore.listRunIssues({ ...runFilter, limit: 400 }),
  syncStore.listIssueTypeCounts(runFilter),
]);
---

<Layout title="Issue Dashboard | Hjertestarterregister2OSM">
  <Panel>
    <Fragment slot="header">
      <div>
        <p class="eyebrow">Issue Monitoring</p>
        <h2>Current issues from latest run</h2>
      </div>
    </Fragment>
    <IssueTypeCountList
      counts={issueTypeCounts}
      layout="grid"
      emptyText="No issue categories found."
    />
  </Panel>

  <Panel>
    <Fragment slot="header">
      <h3>Current issues</h3>
      <span>{formatNumber(issues.length)} shown</span>
    </Fragment>
    <IssueCards issues={issues} />
  </Panel>
</Layout>
